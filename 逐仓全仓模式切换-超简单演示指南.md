# 🎯 逐仓/全仓模式切换 - 超简单演示指南

## 📌 只需要做 3 件事！

---

## 第一件事：打开浏览器（1 分钟）

**复制这个链接到浏览器**：
```
http://localhost:3000/?account=0x70997970C51812dc3A010C7d01b50e0d17dc79C8
```

**你应该看到**：
- 右上角显示 `Bob` 或 `0x7099...`
- `Margin Mode` 显示 `CROSS`
- `Cross Margin` 大约 499 ETH

**如果看不到或余额不对，执行这个命令**：
```bash
export CONTRACT=0x6da9aaf6b5238586878468b1ebe197a9f1a0e28d
cast rpc anvil_impersonateAccount 0x70997970C51812dc3A010C7b50e0d17dc79C8 --rpc-url http://127.0.0.0.1:8545 >/dev/null
cast send $CONTRACT "deposit()" --from 0x70997970C51812dc3A010C7b50e0d17dc79C8 --value 10000000000000000000 --rpc-url http://127.0.0.0.1:8545 --unlocked
```

---

## 第二件事：演示步骤（15 分钟）

### ✅ 步骤 1：CROSS 模式下单（前端操作）

**做这些**：
1. 看到 **"CROSS"** 按钮是白色的
2. **Order Type** 选 **"Market"**
3. **Amount** 输入 `0.05`
4. 点击 **"Buy / Long"**

**应该看到**：
- ✅ 按钮变 "Pending..." 然后恢复
- ✅ Position 显示 `+0.05 ETH`

**✅ 成功！这就是 CROSS 模式交易**

---

### ❌ 步骤 2：尝试切换模式（演示保护机制）

**做这些**：
1. 点击 **"Isolated"** 按钮
2. **Amount** 输入 `0.01`
3. 点击 **"Buy / Long"**

**应该看到**：
- ❌ 显示错误：`cannot change margin mode on existing position`

**✅ 成功！这就是模式保护机制**

---

### ✅ 步骤 3：平仓（命令行操作）

**复制这整段命令到终端**：
```bash
export CONTRACT=0x6da9aaf6b5238586878468b1ebe197a9f1a0e28d
cast rpc anvil_impersonateAccount 0x70997970C51812dc3A010C7b50e0d17dc79C8 --rpc-url http://127.0.0.0.1:8545 >/dev/null
cast send $CONTRACT "placeOrder(bool,uint256,uint256,uint256,uint8)" false 2950000000000000000 50000000000000000 --from 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 --rpc-url http://127.0.0.0.1:8545 --unlocked
```

**应该看到**：
- ✅ 输出 `status: 1`
- ✅ Position 消失或变成 0

**✅ 成功！仓位已清空**

---

### ✅ 步骤 4：切换到 ISOLATED 模式（前端操作）

**做这些**：
1. 确认 **"Isolated"** 按钮是白色的
2. **Amount** 输入 `0.03`
3. 点击 **"Buy / Long"**

**应该看到**：
- ✅ 交易成功
- ✅ `Margin Mode` 变成 **ISOLATED**
- ✅ Position 显示 `+0.03 ETH`

**✅ 成功！已切换到 ISOLATED 模式**

---

### ✅ 步骤 5：测试保证金分配（前端操作）

#### 5.1 Allocate（分配保证金）
1. 在 **"Allocate to Isolated"** 输入 `2`
2. 点击 **"Allocate →"**

**应该看到**：
- ✅ `Cross Margin` 减少
- ✅ `Isolated Margin` 增加

#### 5.2 Remove（回收保证金）
1. 在 **"Remove from Isolated"** 输入 `0.5`
2. 点击 **"← Remove"**

**应该看到**：
- ✅ `Cross Margin` 增加
- ✅ `Isolated Margin` 减少

**✅ 成功！保证金管理演示完成**

---

## 📊 演示效果总结

观众会学到：
1. ✅ **CROSS 模式**: 简单直接
2. ✅ **模式保护**: 有仓时不能切换
3. ✅ **ISOLATED 模式**: 风险隔离
4. ✅ **保证金管理**: 灵活分配

---

## 🔧 如果出错了

### 问题：交易失败
```bash
# 取消所有旧订单
export CONTRACT=0x6da9aaf6b5238586878468b1ebe197a9f1a0e28d
cast rpc anvil_impersonateAccount 0x70997970C51812dc3A010C7b50e0d17dc79C8 --rpc-url http://127.0.0.1:8545 >/dev/null
for i in {1..50}; do
  cast send $CONTRACT "cancelOrder(uint256)" $i --from 0x70997970C51812dc3A010C7b50e0d17dc79C8 --rpc-url http://127.0.0.0.1:8545 --unlocked >/dev/null 2>&1
done
echo "✅ 已清理所有订单"
```

### 问题：前端不更新
- 按 **Ctrl + Shift + R** 强制刷新浏览器

### 问题：找不到合约
```bash
cat /mnt/c/Users/a/Desktop/perpm-course2/frontend/.env.local | grep EXCHANGE_ADDRESS
# 应该显示: 0x6da9aaf6b25a37728a3b1570f7c9d1ea1a48f75a6b
```

---

## ✅ 演示检查清单

完成后确认：
- [ ] CROSS 模式下单成功
- [ ] 模式切换失败（符合预期）
- [ ] 平仓成功
- [ ] ISOLATED 模式下单成功
- [ ] Allocate/Remove 成功

---

## 🎉 恭喜！演示完成！

**你刚刚演示了**：
1. ✅ 两种保证金模式的区别
2. ✅ 模式切换的时机和限制
3. **核心功能**：从 CROSS 切换到 ISOLATED

**记住要点**：
- 空仓时可自由切换
- 有仓时模式锁定
- 平仓后可重新选择

---

**文件位置**: `/mnt/c/Users/a/Desktop/perpm-course2/逐仓全仓模式切换-超简单演示指南.md`
