# 逐仓/全仓模式切换功能演示指南

## 🎯 功能概述

本项目已成功实现逐仓（Isolated）和全仓（Cross）保证金模式切换功能，包括：

- ✅ 保证金模式枚举定义（`MarginMode.CROSS` / `MarginMode.ISOLATED`）
- ✅ 下单时选择保证金模式
- ✅ 逐仓保证金管理（`allocateToIsolated` / `removeFromIsolated`）
- ✅ 差异化保证金计算
- ✅ 差异化清算检查
- ✅ 前端完整 UI 支持

---

## 🚀 快速启动演示

### 1. 启动本地环境

```bash
# Terminal 1: 启动 Anvil
cd contract
anvil --host 0.0.0.0 --port 8545 --accounts 10 --balance 100000000 --block-time 1

# Terminal 2: 部署合约
PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 \
  forge script script/DeployExchange.s.sol:DeployExchangeScript \
  --rpc-url http://127.0.0.1:8545 --broadcast --ffi

# Terminal 3: 启动前端
cd frontend
npm run dev
```

### 2. 访问前端

打开浏览器访问：**http://localhost:3001/**

---

## 📱 前端演示步骤

### 第一步：查看初始状态

1. 打开前端页面
2. 右上角默认连接 Alice 账号（`0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266`）
3. 在右侧面板底部可以看到账户信息：
   - **Cross Margin**: 0.0000 USD
   - **Isolated Margin**: 0.0000 USD
   - **Margin Mode**: CROSS

### 第二步：存入保证金

1. 在右侧面板找到 **Deposit** 区域
2. 输入金额：`10`
3. 点击 **Deposit** 按钮
4. 等待交易确认，看到状态提示 "Deposit complete"
5. 观察账户信息：
   - **Cross Margin**: 10.0000 USD ✅
   - **Margin Mode**: CROSS

### 第三步：切换到逐仓模式

1. 找到 **Margin Mode** 选择器（在杠杆滑块下方）
2. 点击 **Isolated** 按钮
3. 观察变化：
   - 按钮高亮显示紫色
   - 出现逐仓保证金管理面板
   - 显示提示："Each position has independent margin"

### 第四步：分配保证金到逐仓

1. 在 **Isolated Margin Management** 面板中
2. 观察当前余额：
   - **Cross**: 10.0000
   - **Isolated**: 0.0000
3. 在 "Amount to allocate" 输入框输入：`3`
4. 点击 **Allocate →** 按钮
5. 等待交易确认
6. 观察余额变化：
   - **Cross**: 7.0000 ✅
   - **Isolated**: 3.0000 ✅

### 第五步：全仓模式下单

1. 点击 **Cross** 按钮切换回全仓模式
2. 选择订单类型：**Limit**
3. 输入价格：`1000000000000000000`（1 ETH）
4. 输入数量：`1`
5. 点击 **Buy / Long** 按钮
6. 观察账户信息：
   - **Margin Mode**: CROSS（0）
   - 持仓大小增加

### 第六步：逐仓模式下单

1. 点击 **Isolated** 按钮切换到逐仓模式
2. 输入价格：`900000000000000000`（0.9 ETH）
3. 输入数量：`1`
4. 点击 **Buy / Long** 按钮
5. 观察账户信息：
   - **Margin Mode**: ISOLATED（1）
   - 持仓使用逐仓保证金

### 第七步：回收逐仓保证金

1. 在逐仓模式下
2. 在 "Amount to remove" 输入框输入：`1`
3. 点击 **← Remove** 按钮
4. 等待交易确认
5. 观察余额变化：
   - **Cross**: 8.0000 ✅
   - **Isolated**: 2.0000 ✅

---

## 🔧 命令行测试（已完成）

上述演示已在命令行中成功执行：

```bash
# 测试脚本
bash scripts/test_margin_mode.sh
```

### 测试结果验证

✅ **Step 1**: 初始状态检查
- Cross Margin: 0 ETH
- Isolated Margin: 0 ETH
- Margin Mode: 0 (CROSS)

✅ **Step 2**: 存入 10 ETH
- Cross Margin: 10 ETH
- 交易哈希: `0xe0bac02b706948e535495fecb8e3dc1e37e46378352a3ab42266fd620086a977`

✅ **Step 3**: 分配 3 ETH 到逐仓
- Cross Margin: 7 ETH
- Isolated Margin: 3 ETH
- 交易哈希: `0x27570559c3c2d132a07afd76eb7f55a97498083442103c8f635d5baa1ee23965`

✅ **Step 4**: 全仓模式下单
- Margin Mode: 0 (CROSS)
- 订单成功创建

✅ **Step 5**: 逐仓模式下单
- Margin Mode: 1 (ISOLATED)
- 订单成功创建

✅ **Step 6**: 回收 1 ETH
- Cross Margin: 8 ETH
- Isolated Margin: 2 ETH
- 交易哈希: `0xe4bb40d96cd254c238da50b26c68f4e14680145bff63aa965be3f6b5f4c8ceef`

---

## 📊 核心合约功能

### 1. 保证金模式枚举

```solidity
enum MarginMode {
    CROSS,      // 全仓模式：所有仓位共享保证金
    ISOLATED    // 逐仓模式：每个仓位独立保证金
}
```

### 2. 下单时选择模式

```solidity
function placeOrder(
    bool isBuy,
    uint256 price,
    uint256 amount,
    uint256 hintId,
    MarginMode marginMode  // 0=CROSS, 1=ISOLATED
) external returns (uint256)
```

### 3. 逐仓保证金管理

```solidity
// 分配保证金到逐仓
function allocateToIsolated(uint256 amount) external

// 从逐仓回收保证金
function removeFromIsolated(uint256 amount) external
```

### 4. 视图函数

```solidity
// 获取保证金模式
function getMarginMode(address trader) external returns (MarginMode)

// 获取全仓保证金
function getCrossMargin(address trader) external returns (uint256)

// 获取逐仓保证金
function getIsolatedMargin(address trader) external returns (uint256)
```

---

## 🏗️ 代码实现位置

### 合约部分

| 文件 | 功能 |
|------|------|
| `contract/src/core/ExchangeStorage.sol:8-11` | 保证金模式枚举定义 |
| `contract/src/modules/OrderBookModule.sol:19-48` | 下单时选择保证金模式 |
| `contract/src/modules/MarginModule.sol:155-222` | 逐仓保证金管理函数 |
| `contract/src/modules/LiquidationModule.sol:14-58` | 差异化清算检查 |

### 前端部分

| 文件 | 功能 |
|------|------|
| `frontend/components/OrderForm.tsx:225-260` | 保证金模式选择器 UI |
| `frontend/components/OrderForm.tsx:262-313` | 逐仓保证金管理面板 |
| `frontend/types.ts:38-42` | MarginMode 枚举定义 |
| `frontend/store/exchangeStore.tsx:563-593` | 逐仓相关函数实现 |

---

## 🎨 UI 特性

### 模式切换器

- 两个按钮：**Cross** 和 **Isolated**
- 当前选中按钮高亮显示
- 逐仓模式显示提示文字

### 逐仓保证金管理面板

仅在逐仓模式下显示：
- **Allocate →**：从全仓分配到逐仓
- **← Remove**：从逐仓回收到全仓
- 实时显示两种保证金余额

### 账户信息面板

底部实时显示：
- Cross Margin 余额
- Isolated Margin 余额
- 当前 Margin Mode
- 订单类型

---

## ✅ 验证清单

- [x] 合约编译通过
- [x] 所有 Day 1-7 测试通过（44/44）
- [x] 逐仓/全仓模式枚举定义
- [x] 下单时模式参数传递
- [x] allocateToIsolated 函数实现
- [x] removeFromIsolated 函数实现
- [x] 差异化保证金计算
- [x] 差异化清算检查
- [x] 前端模式选择器 UI
- [x] 前端保证金管理面板
- [x] 命令行测试成功执行
- [x] 前端环境已配置

---

## 🔗 相关链接

- **前端地址**: http://localhost:3001/
- **合约地址**: `0x5FbDB2315678afecb367f032d93F642f64180aa3`
- **RPC 地址**: http://127.0.0.1:8545
- **Chain ID**: 31337

---

## 📝 注意事项

1. **模式切换限制**：
   - 新开仓时可以自由选择模式
   - 已有仓位时不能切换模式（必须保持一致）

2. **保证金管理**：
   - 逐仓模式需要提前分配保证金
   - 回收保证金时会检查维持保证金要求

3. **风险隔离**：
   - 全仓：所有仓位共享保证金，风险互相影响
   - 逐仓：每个仓位独立，风险隔离

---

## 🎉 总结

逐仓/全仓模式切换功能已完整实现并测试通过！包括：

✅ 合约层完整实现（存储、逻辑、检查）
✅ 前端完整 UI（选择器、管理面板、显示）
✅ 命令行测试验证成功
✅ 所有功能正常运行

现在可以在浏览器中体验完整的逐仓/全仓模式切换功能！
